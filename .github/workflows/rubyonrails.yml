name: "Ruby on Rails CI"

on: [push, pull_request, workflow_dispatch]

jobs:
  test:
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        test_group:
          - name: unit
            paths: spec/models spec/policies spec/helpers spec/mailers spec/services spec/components spec/decorators spec/jobs spec/lib spec/tasks spec/views
            needs_playwright: false
          - name: integration
            paths: spec/requests spec/controllers
            needs_playwright: false
          - name: system
            paths: spec/system
            needs_playwright: true

    name: test (${{ matrix.test_group.name }})

    services:
      postgres:
        image: postgres:16-alpine
        ports:
          - "5432:5432"
        env:
          POSTGRES_DB: rails_test
          POSTGRES_USER: rails
          POSTGRES_PASSWORD: password
      redis:
        image: redis:alpine
        ports: ["6379:6379"]
        options: --entrypoint redis-server

    env:
      RAILS_ENV: test
      DATABASE_URL: "postgres://rails:password@localhost:5432/rails_test"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 100
          submodules: recursive

      - name: Install Ruby and gems
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"


      - name: Install Dependencies for canvas
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libjpeg-dev libpango1.0-dev libgif-dev build-essential g++ yosys

      - name: Install reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest

      - run: yarn install

      - name: Get Playwright version
        if: matrix.test_group.needs_playwright
        id: playwright-version
        run: |
          PLAYWRIGHT_VERSION=$(bundle exec ruby -e 'require "playwright"; puts Playwright::COMPATIBLE_PLAYWRIGHT_VERSION.strip')
          echo "version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        if: matrix.test_group.needs_playwright
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright and browsers
        if: matrix.test_group.needs_playwright
        run: |
          yarn add -D "playwright@${{ steps.playwright-version.outputs.version }}"
          if [ "${{ steps.playwright-cache.outputs.cache-hit }}" != "true" ]; then
            npx playwright install --with-deps
          else
            npx playwright install-deps
          fi

      - name: Copy the sample ENV Config
        run: cp .env.example .env

      - name: Set up database schema
        run: bin/rails db:schema:load

      - name: Run data migration tasks
        run: bin/rails data:migrate

      - name: Cache compiled assets
        uses: actions/cache@v4
        with:
          path: |
            public/assets
            tmp/cache
          key: assets-${{ runner.os }}-${{ hashFiles('app/assets/**', 'app/javascript/**', 'config/initializers/assets.rb', 'yarn.lock') }}
          restore-keys: |
            assets-${{ runner.os }}-

      - name: Build assets
        run: |
          yarn run build
          bin/rails assets:clobber
          bin/rails assets:precompile

      - name: Configure keys
        run: |
          openssl genrsa -out config/private.pem 2048
          openssl rsa -in config/private.pem -outform PEM -pubout -out config/public.pem

      - name: Run tests
        run: bundle exec rspec ${{ matrix.test_group.paths }}

      - name: Keep screenshots from failed system tests
        uses: actions/upload-artifact@v4
        if: failure() && matrix.test_group.name == 'system'
        with:
          name: screenshots
          path: ${{ github.workspace }}/tmp/capybara
          if-no-files-found: ignore

      - uses: aki77/delete-pr-comments-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          bodyContains: "[undercover]"
          noReply: "true"

  type-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Ruby and gems
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Static type checking
        run: |
          bundle exec rbs collection install
          bundle exec steep check

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Ruby and gems
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Security audit dependencies
        run: bundle exec bundler-audit --update

      - name: Lint Ruby files
        run: bundle exec rubocop --parallel
